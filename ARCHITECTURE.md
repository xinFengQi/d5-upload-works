# 项目架构说明

## 整体架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     客户端 (Browser/App)                     │
└───────────────────────────┬─────────────────────────────────┘
                             │ HTTPS
                             ▼
┌─────────────────────────────────────────────────────────────┐
│              Cloudflare Workers (边缘计算)                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              路由层 (Router)                          │  │
│  │  - index.ts: 入口文件，处理所有请求                   │  │
│  │  - router.ts: 路由分发                                │  │
│  └───────────────┬──────────────────────────────────────┘  │
│                  │                                         │
│  ┌───────────────▼──────────────────────────────────────┐  │
│  │              路由处理层 (Routes)                      │  │
│  │  - auth.ts: 认证路由（钉钉登录）                      │  │
│  │  - upload.ts: 文件上传路由                            │  │
│  │  - works.ts: 作品管理路由                            │  │
│  └───────────────┬──────────────────────────────────────┘  │
│                  │                                         │
│  ┌───────────────▼──────────────────────────────────────┐  │
│  │              服务层 (Services)                        │  │
│  │  - oss.ts: 阿里云 OSS 服务封装                       │  │
│  │  - dingtalk.ts: 钉钉认证服务                         │  │
│  │  - kv.ts: Workers KV 服务封装                      │  │
│  └───────────────┬──────────────────────────────────────┘  │
│                  │                                         │
│  ┌───────────────▼──────────────────────────────────────┐  │
│  │              工具层 (Utils)                           │  │
│  │  - env.ts: 环境变量管理                              │  │
│  │  - response.ts: 响应格式化                           │  │
│  │  - validation.ts: 数据验证                           │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────┬─────────────────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐      ┌───────────────┐
│ Workers KV    │      │  阿里云 OSS    │
│ (数据存储)    │      │  (文件存储)    │
└───────────────┘      └───────────────┘
```

## 数据流

### 1. 用户认证流程

```
用户 → GET /auth/dingtalk
     ↓
Workers → 生成 state，重定向到钉钉登录页面
     ↓
钉钉 → 用户登录，回调到 /auth/callback?code=xxx&state=xxx
     ↓
Workers → 使用 code 换取 access_token
     ↓
Workers → 使用 access_token 获取用户信息
     ↓
Workers → 生成 session token，存储到 KV
     ↓
Workers → 返回 session token 给客户端
```

### 2. 文件上传流程

```
客户端 → POST /api/upload (multipart/form-data)
       ↓
Workers → 验证 Authorization header (session token)
       ↓
Workers → 验证文件类型和大小
       ↓
Workers → 调用 OSS 服务上传文件
       ↓
阿里云 OSS → 返回文件 URL
       ↓
Workers → 保存作品信息到 KV (用户ID、文件URL、元数据等)
       ↓
Workers → 返回作品信息给客户端
```

### 3. 作品查询流程

```
客户端 → GET /api/works?page=1&limit=10
       ↓
Workers → 验证 Authorization header
       ↓
Workers → 从 KV 查询用户的作品列表 (使用 userId 作为前缀)
       ↓
Workers → 分页处理
       ↓
Workers → 返回作品列表
```

## 存储设计

### Workers KV 数据结构

#### 用户会话存储
- Key: `session:{token}`
- Value: `UserSession` (JSON)
- TTL: 7天

#### 用户信息存储
- Key: `user:{userId}`
- Value: `DingTalkUser` (JSON)
- TTL: 无（永久存储）

#### 作品存储
- Key: `work:{workId}`
- Value: `Work` (JSON)
- TTL: 无（永久存储）

#### 用户作品索引
- Key: `user_works:{userId}:{workId}`
- Value: `workId` (字符串)
- TTL: 无（永久存储）

### 阿里云 OSS 存储结构

```
bucket/
├── works/
│   ├── {userId}/
│   │   ├── {workId}/
│   │   │   └── {filename}
```

## 安全设计

### 1. 认证安全
- 使用 HTTPS 传输
- Session token 使用随机生成，存储在 KV 中
- Token 有过期时间（7天）
- 验证 token 时检查过期时间

### 2. 文件上传安全
- 验证文件类型（白名单）
- 限制文件大小（如 100MB）
- 验证用户身份
- 文件名使用 UUID，防止路径遍历

### 3. 数据安全
- 所有敏感信息通过环境变量配置
- 使用 Wrangler secrets 管理生产环境密钥
- 不在代码中硬编码密钥
- 不在日志中输出敏感信息

## 性能优化

### 1. Workers KV 优化
- 使用批量操作减少请求次数
- 合理设置 TTL，避免数据过期问题
- 使用前缀查询优化列表查询

### 2. OSS 优化
- 考虑使用预签名 URL 进行客户端直传（可选）
- 使用 CDN 加速文件访问
- 合理设置文件缓存策略

### 3. Workers 优化
- 使用边缘计算，减少延迟
- 合理使用 Workers 的 CPU 时间限制
- 优化代码体积

## 扩展性考虑

### 1. 数据存储扩展
- 如果 Workers KV 不够用，可以考虑：
  - 使用 Durable Objects（强一致性）
  - 使用外部数据库（如 Cloudflare D1）

### 2. 文件存储扩展
- 如果 OSS 不够用，可以考虑：
  - 使用 Cloudflare R2（兼容 S3 API）
  - 使用其他对象存储服务

### 3. 功能扩展
- 支持多文件上传
- 支持文件预览
- 支持作品分类/标签
- 支持作品分享
- 支持作品评论

## 技术选型说明

### 为什么选择 Cloudflare Workers？
- 边缘计算，全球低延迟
- 按请求计费，成本低
- 与 Cloudflare 生态集成好
- 支持 TypeScript

### 为什么选择 Workers KV？
- 与 Workers 集成好
- 全球分布，低延迟
- 适合存储非关键数据
- 成本低

### 为什么选择阿里云 OSS？
- 国内访问速度快
- 成本相对较低
- API 简单易用
- 支持多种存储类型

### 为什么选择钉钉登录？
- 企业级认证
- 用户信息完整
- 安全性高
- 集成简单

## 部署架构

### 开发环境
- 使用 `wrangler dev` 本地开发
- 使用 `.dev.vars` 配置环境变量
- 使用预览 KV 命名空间

### 生产环境
- 使用 `wrangler deploy` 部署
- 使用 Wrangler secrets 管理密钥
- 使用生产 KV 命名空间
- 配置自定义域名（可选）

## 监控和日志

### 日志
- 使用 `console.log`、`console.error` 输出日志
- 使用 `wrangler tail` 查看实时日志
- 重要操作记录日志

### 监控
- 使用 Cloudflare Analytics 查看请求统计
- 监控 Workers 执行时间
- 监控 KV 读写次数
- 监控错误率
