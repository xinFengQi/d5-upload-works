---
description: "安全规范：密钥管理、API 安全和数据验证"
alwaysApply: true
---

# 安全规范

## 1. 密钥管理
- **禁止**在代码中硬编码任何密钥
- **禁止**在 Git 仓库中提交包含密钥的文件
- 所有敏感信息通过环境变量配置，存放在 `server/.env`（已加入 .gitignore）
- 生产环境使用服务器环境变量或密钥管理服务，勿将 `.env` 提交仓库

## 2. API 安全
- 需要认证的接口使用 `requireUser` / `requireAdmin` 中间件验证身份
- 生产环境使用 HTTPS
- 上传接口校验文件类型和大小
- 钉钉回调校验 state（防 CSRF）

## 3. 数据验证
- 所有用户输入必须校验（类型、长度、范围）
- 上传前校验：文件类型白名单（MP4/MOV/AVI）、大小（≤100MB）、标题非空且唯一
- 大屏配置：gridLayout 白名单、theme 颜色为十六进制

## 4. 会话管理
- Session token 随机生成（`utils/crypto.js`）
- Token 存 SQLite sessions 表，过期时间 7 天
- 验证 token 时检查 expires_at，过期则删除并返回 401
- 退出时删除对应 session

## 5. 文件上传安全
- 白名单文件类型，限制 100MB
- OSS key 使用 `works/{userId}/{workId}.{ext}`，避免路径遍历
- 上传接口需登录（requireUser）

## 6. 日志安全
- 不输出密钥、密码、token
- 错误日志不暴露内部细节
- AccessKey 仅显示前 8 字符；Secret 不输出
- 生产环境错误响应不含详细调试信息

## 7. 错误响应安全
- 生产环境只返回必要错误信息
- 判断开发环境：`ENVIRONMENT` 或 host 为 localhost
- 错误响应不暴露 bucket、region 等配置

## 8. 已知安全限制
- 钉钉部分 API 在 URL 中传递 appsecret，属 API 限制；确保日志不记录含敏感信息的 URL（`server/services/dingtalk.js`）

## 9. 安全审计
- 定期检查日志与错误响应
- 确保 ADMIN_PASSWORD 强度
- 确认 `server/.env` 未提交、`.gitignore` 包含 `.env`
