---
description: "作品上传系统项目概述、技术栈和整体架构说明"
alwaysApply: true
---

# 作品上传系统 - 项目概述

## 项目简介
这是一个基于 Cloudflare Workers 的作品上传系统，使用 Workers KV 进行数据存储，集成阿里云 OSS 进行文件上传，支持钉钉登录认证。

## 技术栈
- **运行时**: Cloudflare Workers (使用 Wrangler 部署)
- **存储**: Cloudflare Workers KV
- **文件存储**: 阿里云 OSS (通过 SDK)
- **认证**: 钉钉 OAuth 登录
- **语言**: TypeScript
- **构建工具**: Wrangler / esbuild

## 项目架构

### 目录结构
```
├── src/
│   ├── index.ts              # Workers 入口文件
│   ├── router.ts             # 路由分发
│   ├── routes/               # 路由处理
│   │   ├── auth.ts          # 认证相关路由（钉钉登录）
│   │   ├── upload.ts        # 文件上传路由
│   │   └── works.ts         # 作品管理路由
│   ├── services/            # 业务服务层
│   │   ├── oss.ts           # 阿里云 OSS 服务
│   │   ├── dingtalk.ts      # 钉钉认证服务
│   │   └── kv.ts            # KV 存储服务
│   ├── utils/               # 工具函数
│   │   ├── env.ts           # 环境变量验证
│   │   ├── response.ts      # 响应格式化
│   │   └── validation.ts    # 数据验证
│   └── types/               # TypeScript 类型定义
│       ├── env.d.ts         # 环境变量类型
│       ├── user.ts          # 用户类型
│       ├── work.ts          # 作品类型
│       └── api.ts           # API 类型
├── wrangler.toml            # Wrangler 配置文件
├── package.json             # 项目依赖
├── tsconfig.json            # TypeScript 配置
└── README.md                # 使用文档
```

### 核心模块说明

#### 1. 认证模块 (auth.ts)
- 处理钉钉 OAuth 登录流程
- 管理用户会话（使用 KV 存储）
- 验证用户身份

#### 2. 上传模块 (upload.ts)
- 接收文件上传请求
- 调用阿里云 OSS SDK 上传文件
- 记录上传信息到 KV

#### 3. 作品管理模块 (works.ts)
- 作品列表查询
- 作品详情获取
- 作品删除/更新

#### 4. OSS 服务 (oss.ts)
- 封装阿里云 OSS SDK
- 处理文件上传逻辑
- 生成文件访问 URL

#### 5. 钉钉服务 (dingtalk.ts)
- 钉钉 OAuth 认证
- 用户信息获取
- Token 管理

#### 6. KV 服务 (kv.ts)
- 封装 Workers KV 操作
- 用户数据存储
- 作品数据存储

## 开发流程

### 1. 本地开发
```bash
npm install
npm run dev
```

### 2. 环境配置
- 复制 `.dev.vars.example` 为 `.dev.vars`
- 填写必要的环境变量

### 3. 测试
- 使用 Wrangler 本地测试
- 测试所有 API 端点
- 验证文件上传功能
- 测试钉钉登录流程

### 4. 部署
```bash
npm run deploy
```

## 注意事项

### Workers KV
- KV 是最终一致性存储，可能有延迟
- 适合存储非关键数据
- 注意 KV 的读写限制

### 阿里云 OSS
- 使用 Workers 的 fetch API 调用 OSS SDK
- 注意文件大小限制
- 考虑使用预签名 URL 进行客户端直传（可选）

### 钉钉登录
- 正确处理 OAuth 回调
- 管理好用户会话
- 注意 token 过期处理
