---
description: "作品上传系统项目概述 - Node 服务端 + 静态前端"
alwaysApply: true
---

# 作品上传系统 - 项目概述

## 项目简介
基于 Node.js + Express 的作品上传系统，使用 SQLite 本地数据库，集成阿里云 OSS 文件上传，支持钉钉登录认证。前端为静态 HTML/JS，由 Nginx 或 Node 提供。

## 技术栈
- **服务端**: Node.js + Express
- **数据库**: SQLite（better-sqlite3），数据文件 `server/data/app.db`
- **文件存储**: 阿里云 OSS (REST API + HMAC-SHA1 签名)
- **认证**: 钉钉 OAuth 登录
- **前端**: 静态 HTML/CSS/JS，位于 `frontend/public/`

## 项目架构

### 目录结构
```
├── server/                   # Node 服务端
│   ├── data/                 # SQLite 数据目录（部署时需持久化）
│   ├── db/                   # 数据库
│   │   ├── schema.sql       # 表结构
│   │   ├── index.js         # 连接与初始化
│   │   └── init.js          # 独立建表脚本
│   ├── middleware/auth.js   # 鉴权中间件
│   ├── routes/              # API 路由
│   │   ├── auth.js          # 认证（钉钉、管理员、登出）
│   │   ├── upload.js        # 文件上传
│   │   ├── works.js         # 作品列表/删除
│   │   ├── vote.js          # 投票
│   │   └── screen-config.js # 大屏配置
│   ├── services/            # 业务服务
│   │   ├── oss.js           # 阿里云 OSS
│   │   └── dingtalk.js      # 钉钉 OAuth
│   ├── utils/response.js, crypto.js
│   ├── app.js               # Express 应用
│   └── server.js            # 入口
├── frontend/public/          # 静态前端
│   ├── index.html           # 首页
│   ├── login.html, upload.html, admin.html
│   ├── screen.html, multi-screen.html, vote-result.html
├── package.json
└── README.md
```

### 核心模块说明

#### 1. 认证 (auth.js)
- 钉钉登录入口 `/auth/dingtalk`、回调 `/auth/callback`
- 当前用户 `/auth/me`、管理员登录 `POST /auth/admin`、退出 `POST /auth/logout`
- 会话与用户信息存 SQLite（sessions、users、auth_states）

#### 2. 上传 (upload.js)
- `POST /api/upload`，需登录，multer 解析 multipart
- 校验文件类型（MP4/MOV/AVI）、大小（≤100MB）、标题唯一
- 上传 OSS 后写入 works 表

#### 3. 作品 (works.js)
- `GET /api/works` 分页列表（含 voteCount）
- `GET /api/works/top` 按投票数排序
- `DELETE /api/works/:workId` 仅管理员，同步删 OSS 与 votes

#### 4. 投票 (vote.js)
- `POST /api/vote`、`DELETE /api/vote`、`GET /api/vote/stats`、`GET /api/vote/user/count`、`GET /api/vote/users`（管理员）
- 投票记录存 votes 表，每人每作品一票，每人最多 10 票

#### 5. 大屏配置 (screen-config.js)
- `GET/POST /api/screen-config`，POST 仅管理员
- 存 screen_config 表（gridLayout、theme）

#### 6. 数据持久化（重要）
- 数据库文件：`server/data/app.db`
- 部署时必须将 `data` 目录放在持久化存储（挂载卷），否则重新部署会丢失数据。详见 `server/DEPLOY.md`。

## 开发与部署

### 本地运行
```bash
cd server
npm install
cp .env.example .env   # 填写 OSS、钉钉、ADMIN_PASSWORD
node db/init.js        # 可选，首次建表
npm start              # 默认 http://localhost:3000
```
前端由 Node 从 `frontend/public` 提供；生产建议 Nginx 提供静态并代理 `/api`、`/auth` 到 Node。见 `server/DEPLOY.md`。

### 环境变量
在 `server/.env` 中配置：PORT、ALIYUN_OSS_*、DINGTALK_*、ADMIN_PASSWORD、ENVIRONMENT。
