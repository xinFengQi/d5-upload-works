---
description: "服务层设计规范和实现标准"
globs:
  - "**/services/**/*.ts"
---

# 服务层规范

## 服务类设计
所有服务应该：
1. 封装外部依赖（OSS、钉钉、KV）
2. 提供清晰的 API
3. 处理错误和异常
4. 使用类型定义确保类型安全

## OSS 服务 (oss.ts)
- 封装阿里云 OSS SDK
- 提供 `uploadFile(file: File, key: string)` 方法
- 提供 `deleteFile(key: string)` 方法
- 提供 `getFileUrl(key: string)` 方法
- 注意：在 Workers 环境中，需要使用 fetch API 调用 OSS SDK

## 钉钉服务 (dingtalk.ts)
- 封装钉钉 OAuth 认证流程
- 提供 `getAuthUrl(state?: string)` 方法
- 提供 `getAccessToken(code: string)` 方法
- 提供 `getUserInfo(accessToken: string)` 方法
- 处理 token 过期和刷新

## KV 服务 (kv.ts)
- 封装 Workers KV 操作
- 提供 `get<T>(key: string)` 方法
- 提供 `set(key: string, value: any, expirationTtl?: number)` 方法
- 提供 `delete(key: string)` 方法
- 提供 `list(prefix?: string)` 方法
- 注意 KV 的最终一致性特性

## 服务使用模式
在路由处理中使用服务：
```typescript
const ossService = new OSSService(env);
const dingtalkService = new DingTalkService(env);
const kvService = new KVService(env.MY_KV);
```

## 错误处理
- 服务方法应该抛出有意义的错误
- 在路由层捕获并转换为统一的错误响应
- 记录服务调用错误
