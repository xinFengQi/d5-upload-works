---
description: "服务层规范（OSS、钉钉、数据库）"
globs:
  - "server/services/**/*.js"
  - "server/db/**/*.js"
---

# 服务层规范

## 数据库 (server/db/)
- `getDb()`：获取 SQLite 单例，首次自动建表（schema.sql）
- 数据文件：`server/data/app.db`，部署时须持久化该目录
- 表：users、sessions、auth_states、works、votes、screen_config

## OSS 服务 (services/oss.js)
- 构造函数接收 `config`（含 ALIYUN_OSS_*）
- `uploadFile(buffer, key, contentType)`：上传，返回文件 URL
- `deleteFile(key)`：删除对象
- `getFileUrl(key)`：生成访问 URL
- 使用 Node `crypto.createHmac('sha1', ...)` 签名，调用 OSS REST API

## 钉钉服务 (services/dingtalk.js)
- 构造函数接收 `config`（含 DINGTALK_*）
- `getAuthUrl(state)`：返回钉钉授权 URL
- `getUserInfoByAuthCode(authCode)`：用 authCode 换 token 并拉取用户信息，返回 `{ userid, name, avatar?, mobile?, email? }`

## 使用方式
- 在路由中：`new OSSService(req.app.locals.config)`、`new DingTalkService(req.app.locals.config)`
- 数据库：`const { getDb } = require('../db'); getDb().prepare(...).run()/.get()/.all()`
